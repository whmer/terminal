<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversa em Tempo Real</title>
</head>
<style>
  *{margin:0;padding:0;box-sizing: border-box;}
:root{
    --sam:"SF Pro Text", "SF Pro Icons", system, -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Helvetica", "Arial", "Lucida Grande", "Ubuntu", "Cantarell", "Fira Sans", sans-serif;
    --color-whats: #a333e4;
    --hazap:hazap;
}
body{font-family: var(--sam);font-size: 20px;background: #000;color: #fff;}
.login{text-align: center;background: #202020;width: 470px;margin: 0 auto 10px;padding: 10px;}
@media(max-width:999px){
    .login{
        width: 80%;
    }
}
.inty{
    width: 100%;
    background: #111111;
    margin: 10px;
    border-radius: 3px;
}

#message-input{
    padding: 10px;
    width: 100%;
    border: none;
    font-family: var(--sam);
    color: #fff;
    background: transparent;
    outline: none;
    font-size: 17px;
}
#hacker{
    font-size: 12px;
    margin-left: 10px;
}

#message-form{
    display: flex;
    background-color: #202020;
    justify-content: space-between;
}

.color-form{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: none;
    background: #000;
    border-top: 1px solid #303030e1;
}

.message{
  width: 450px;
  word-wrap: break-word;
  white-space: normal;
}

@media(max-width:999px){
  .message{
    width: 70%;
  }
}

.ping{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-color: #000;
    border-bottom: 1px solid #303030e1;
    height: 4vh;
}
.pi{font-size: 15px;}

#name-input{padding: 10px;font-family: var(--sam);background: #111111;border: none;outline: none;color: #fff;width: 80%;font-size: 17px;border-radius: 3px;
}
.log--login{font-size: 17px;font-family: var(--sam);font-weight: 600;padding: 10px; border-radius: 3px;border: none;margin-top: 20px;width: 80%;background: var(--color-whats);
}
.message{margin-top: 20px}
.log{font-weight: 500;font-size: 15px;color: #807e7e;
}
#chat-box{
  display: none;
  margin: 20px;
}
.ionicon{width: 40px;}
.uplogf{position: fixed; right:0;
  bottom: 0;}
</style>
<body>
  <div class="content-container">
    <br><br><br>
  <div class="login">
    <br>
    <h2 class="logh2">Login - in</h2>
    <div class="pain">
      <h2 class="log">Crete Username!</h2><br>
      <form class="login--form">
      <input type="text" id="name-input" placeholder="Username" onfocus="this.placeholder=''" onblur="this.placeholder='Username'" required/>
      <!--input type="password" id="pass-input" placeholder="Password" onfocus="this.placeholder=''" onblur="this.placeholder='Password'" required/-->
      <br>
      <button type="submit" class="log--login" onclick="Hacker()">Login</button>
      <br><br>
      </form>
    </div>
  </div>
  <section class="chat">
  </section>
    <section class="message">
    <div id="chat-box"></div>
  </section>
  <br><br><br>
    <div class="color-form">
      <div class="name-hacker">
        <span id="hacker"></span>
        </div>
        <form id="message-form">
          <div class="inty">
            <input type="text" id="message-input" placeholder="Message" required onfocus="this.placeholder=''" onblur="this.placeholder='Message'" required>
          </div>
            <button type="submit" class="sed"><span><svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512"><path d="M470.3 271.15L43.16 447.31a7.83 7.83 0 01-11.16-7V327a8 8 0 016.51-7.86l247.62-47c17.36-3.29 17.36-28.15 0-31.44l-247.63-47a8 8 0 01-6.5-7.85V72.59c0-5.74 5.88-10.26 11.16-8L470.3 241.76a16 16 0 010 29.39z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/></svg></span>Sender</button>
          </form>
    <div class="ping">
      <p class="pi">The internet signal is: <span id="signalStrength">Checking...</span></p>
    </div>
  </div>
</div>
  </section>
  <!--div class="select">
    <label for="uploadImage" class="upload-image">
      <h4>upload</h4>
        <svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512"><rect x="48" y="80" width="416" height="352" rx="48" ry="48" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="32"/><circle cx="336" cy="176" r="32" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"/><path d="M304 335.79l-90.66-90.49a32 32 0 00-43.87-1.3L48 352M224 432l123.34-123.34a32 32 0 0143.11-2L464 368" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/></svg>
      <!--img src="path/to/your/upload-button-image.png" alt="Upload de Imagem">
      <input type="file" id="fileInput" accept="image/*,video/*">
    </label>
      <input type="file" id="image" name="image" accept="image/*" required>
      <button onclick="sendFile()">Enviar para todos</button>
  </div-->
  <!--img id="preview" src="" alt="Pré-visualização da Imagem" style="display: none;">
<div id="mediaContainer"></div-->
<br>
<br>
<script>
const socket = new WebSocket('ws://localhost:3000');

socket.onopen = () => {
  console.log('Conectado ao servidor WebSocket');
};

async function sendFile() {
  const fileInput = document.getElementById('fileInput');
  const usernameInput = document.getElementById('name-input');
  const file = fileInput.files[0];
  const sender = usernameInput.value || "Anônimo";

  if (!file) {
    alert('Selecione um arquivo primeiro.');
    return;
  }

  const arrayBuffer = await file.arrayBuffer();
  const data = {
    sender: sender,
    file: arrayBuffer,
    fileType: file.type,
  };

  socket.send(JSON.stringify(data)); // Envia os dados para o servidor
  fileInput.value = ''; // Limpa o campo de seleção de arquivo
}

socket.onmessage = (event) => {
  const mediaContainer = document.getElementById('mediaContainer');
  const data = JSON.parse(event.data);

  if (data.sender && data.file) {
    // Converte o ArrayBuffer para um Blob e exibe o arquivo
    const blob = new Blob([new Uint8Array(data.file.data)], { type: data.fileType });
    const url = URL.createObjectURL(blob);

    // Cria elementos de mídia com o nome do remetente e data/hora
    const mediaElement = data.fileType.startsWith('video')
      ? document.createElement('video')
      : document.createElement('img');

    mediaElement.src = url;
    mediaElement.controls = true;
    mediaElement.style.maxWidth = '100%';

    displayReceivedMessage(data.sender, mediaElement);
  }
};

// Função para exibir a mídia recebida com remetente e data/hora
function displayReceivedMessage(sender, mediaElement) {
  const now = new Date();
  const options = { hour: '2-digit', minute: '2-digit', hour12: false };
  const formattedDateTime = now.toLocaleDateString('en-US', options);
  const timeTag = `<strong style="font-size:12px; color:#807e7e;">${formattedDateTime}</strong>`;

  const receivedMessageDiv = document.createElement('div');
  receivedMessageDiv.innerHTML = `<strong style="font-size:15px;">${sender} ${timeTag}<br></strong>`;
  receivedMessageDiv.appendChild(mediaElement); // Adiciona a imagem/vídeo
  mediaContainer.appendChild(receivedMessageDiv);
}

</script>
</div>
    <script>
      const ws = new WebSocket('ws://localhost:3000');
      const login = document.querySelector(".login");
      const chat = document.querySelector(".chat");
      const loginForm = login.querySelector(".login--form");
      const nameInput = document.getElementById('name-input');
      const haCker = document.getElementById('hacker');
      const messageInput = document.getElementById('message-input');
      const messageForm = document.getElementById('message-form');
      const chatBox = document.getElementById('chat-box');
      let userName = ''; // Nome do usuário

      function Hacker() {
  var nome = document.getElementById('name-input').value;
  const user = document.getElementById('name-input');
  document.getElementById('hacker').innerText = "user : " + nome;

  if(user.value.trim() !== ''){
    document.querySelector('.color-form').style.display = 'block';
    document.getElementById('chat-box').style.display = 'block';
  }
}1 
      const user = { id: "", name: "" }

      ws.onopen = () => {
        console.log('Connection established with the server.');
        console.log(user)
      };

      const SCroll = () => {
  const scrollableDiv = document.getElementById("chat-box");
  window.scrollTo({
    top: scrollableDiv.scrollHeight,
    behavior: "smooth"
  });
};


      const SCroll3 = () => {
        window.scrollTo({
          //top: document.body.scrollHeight,
          top: document.documentElement.scrollHeight,
          behavior: "smooth"
        });
      };

      ws.onmessage = (event) => {
        handleReceivedMessage(event.data);
      };

      function handleReceivedMessage(data) {
        try {
          const messageData = JSON.parse(data);
          displayReceivedMessage(messageData.sender, messageData.message);
        } catch (error) {
          console.error('Error processing received data:', error);
        }
      }

      ws.onclose = (event) => {
        if (event.wasClean) {
          console.log('Conexão fechada limpa.');
        } else {
          console.error('Conexão interrompida.'); 
        }
      };

      function displayReceivedMessage(sender, message) {
        const now = new Date();
              const options = {
                  hour: '2-digit',
                  minute: '2-digit',
                  //second: '2-digit',
                  hour12 : false
              };
              const formattedDateTime = now.toLocaleDateString('en-US', options);
              const wer = `<strong style="font-size:12px; color:#807e7e;">${formattedDateTime}</strong>`

        const receivedMessageDiv = document.createElement('div');
        receivedMessageDiv.innerHTML = ` 
        <strong style="font-size:15px;">${sender} ${wer}<br></strong>${formatMessage(message)}<br>`;
        chatBox.appendChild(receivedMessageDiv);
      }

      function formatMessage(message) {
  // Verifica se a mensagem contém um link
  const linkRegex = /https?:\/\/\S+/;
  if (linkRegex.test(message)) {
    // Se a mensagem contém um link, aplica um estilo diferente para o link
    return message.replace(linkRegex, '<a href="$&" style="color: #ff0000;" target="_blank">$&</a>');
  } else {
    return message;
  }
}
messageForm.addEventListener('submit', (event) => {
  event.preventDefault();

  userName = nameInput.value || 'Anônimo';

  const message = messageInput.value;
  ws.send(JSON.stringify({ sender: userName, message: message }));

  displaySentMessage(message);

  messageInput.value = ''; // Limpa o campo de entrada após o envio da mensagem
  document.querySelector(".name-input").style.display = "none"
});


// teste ---------------------------

const sendMessage = (event) => {
    event.preventDefault()

    const message = {
        userId: user.id,
        userName: user.name,
        content: messageInput.value
    }
    //websocket.send(JSON.stringify(message))

    messageInput.value = ""
    SCroll();
  }

const handleSubmit = (event) => {
    event.preventDefault()

    user.id = crypto.randomUUID()
    user.name = nameInput.value

    document.querySelector(".login").style.display = "none"
    document.querySelector(".chat").style.display = "flex"

    //websocket = new WebSocket("ws://localhost:8080")
    //websocket.onmessage = processMessage
}

const hacker = (event) => {
  sender = { nameInput }
hacker.innerHTML = `<strong>${sender}:</strong>`;
console.log(`Hello ${sender}`)
}

function checkInternetConnection() {
          fetch('https://www.google.com')
            .then(response => {
              if (response.ok) {
                document.getElementById('signalStrength').textContent = 'Good';
                document.getElementById('signalStrength').style.color = 'green';
              } else {
                document.getElementById('signalStrength').textContent = 'Bad';
                document.getElementById('signalStrength').style.color = 'red';
              }
            })
            .catch(error => {
              document.getElementById('signalStrength').textContent = 'Bad';
              document.getElementById('signalStrength').style.color = 'red';
            });
        }
    
        // Verifica a conexão inicialmente
        checkInternetConnection();
    
        // Verifica a conexão a cada 5 segundos
        setInterval(checkInternetConnection, 5000);

loginForm.addEventListener("submit", handleSubmit)
messageForm.addEventListener("submit", sendMessage )

    </script>
    <style>

:root{
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}


  #image{
    display: none;
  }

  img {
    margin-top: 20px;
    max-width: 100%;
    max-height: 400px;
    border: 1px solid #ddd;
    padding: 5px;
    background-color: #000000;
    width: 80%;
  }

  @keyframes --pish{
    from{
        border: 2px solid #f7f7f7;
        transition: 0.5s;
    }
    to{
        border: 2px dashed #ffffff;
        transition: 0.5s;
    }
  }

  .upload-image {
    cursor: pointer;
    padding: 10px;
    width: 100%;
    margin: 0 auto 10px;
  }


  .select{
    display: flex;
    justify-content: center;
    margin: 0 auto 10px;
    position: fixed;
    right: 0;
    bottom: 10%;
  }

  .filesr{
    text-align: left;
    width: 100%;
    background-color: black;
  }

  .namepas{
    background-color: #080808;
    padding: 10px;
    border-radius: 5px;
    border: none;
    font-family: var(--sam);
    font-size: 20px;
    outline: none;
    color: #ffffff;
    font-weight: 600;

  }


  .btn{
    width: 450px;
    margin-top: 20px;
    justify-content: center;
    background-color: #ffffff;
    font-family: var(--sam);
    font-weight: 600;
    font-size: 18px;
    color: #000000;
    padding: 10px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    transition: 0.5s;
    display:none;
    animation: --desktop 0.7s linear;
  }

  @keyframes --desktop{
    from{
      width: 350px;
    }
    to{
      width: 420px;
    }
  }

  .btn:disabled{
    width: 450px;
    margin-top: 20px;
    justify-content: center;
    background-color: #dd1515;
    font-family: var(--sam);
    font-weight: 600;
    font-size: 18px;
    color: #ffffff;
    padding: 10px 40px;
    border-radius: 20px;
    border: none;
    cursor: not-allowed;
    transition: 0.5s;
    display:none;
    opacity: 0.7;
    animation: --desktop 0.7s linear;
  }

  @media(max-width:999px){
    .btn{
      width: 80%;
       animation: --anime 0.7s linear;
    }
    .btn:disabled{
      width: 80%;
      animation: --anime 0.7s linear;
    }
  }
  

  @keyframes --anime{
    from{
        width: 50%;
        color: transparent;
    }
    to{
        width: 85%;
    }
  }

  .btn:hover{
    background-color: #b9b9b9;
    transition: 0.5s;
  }

    </style>
</body>
</html>
